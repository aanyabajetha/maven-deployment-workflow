name: Build, Publish, and Deploy Mule App

on:
  repository_dispatch:
    types: [deploy-trigger]

jobs:
  build-publish-deploy:
    runs-on: ubuntu-latest

    concurrency:
      group: deploy-${{ github.event.client_payload.app_name }}
      cancel-in-progress: true

    steps:
      - name: Checkout Mule App Source
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.client_payload.repo_owner }}/${{ github.event.client_payload.repo }}
          token: ${{ secrets.PAT }}
          ref: master

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Optional: if your settings.xml is not at root, use appropriate path
      - name: Build Mule Project and Publish to Exchange
        env:
          ANYPOINT_CONNECTED_APP_CLIENT_ID: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_ID }}
          ANYPOINT_CONNECTED_APP_CLIENT_SECRET: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_SECRET }}
        run: |
          mvn clean deploy -s settings.xml -B

      - name: Deploy Mule Application to CloudHub 2.0
        env:
          ANYPOINT_CONNECTED_APP_CLIENT_ID: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_ID }}
          ANYPOINT_CONNECTED_APP_CLIENT_SECRET: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_SECRET }}
          ANYPOINT_URI: ${{ github.event.client_payload.anypoint_uri }}
          ANYPOINT_PROVIDER: ${{ github.event.client_payload.anypoint_provider }}
          ANYPOINT_ENV: ${{ github.event.client_payload.anypoint_env }}
          ANYPOINT_TARGET: ${{ github.event.client_payload.anypoint_target }}
          APP_NAME: ${{ github.event.client_payload.applicationName }}
          APP_REPLICAS: ${{ github.event.client_payload.replicas }}
          APP_VCORES: ${{ github.event.client_payload.vCores }}
          MULE_VERSION: ${{ github.event.client_payload.muleVersion }}
        run: |
          mvn mule:deploy \
            -Danypoint.uri=${ANYPOINT_URI} \
            -Danypoint.provider=${ANYPOINT_PROVIDER} \
            -Danypoint.env=${ANYPOINT_ENV} \
            -Danypoint.target=${ANYPOINT_TARGET} \
            -Dapp.name=${APP_NAME} \
            -Dapp.replicas=${APP_REPLICAS} \
            -Dapp.vcores=${APP_VCORES} \
            -Dapp.runtime=${MULE_VERSION} \
            -s settings.xml -B
